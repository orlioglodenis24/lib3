{% extends 'books/base.html' %}
{% load static %}

{% block title %}Book Catalog - BookDiary{% endblock %}

{% block extra_css %}
<style>

</style>
{% endblock %}

{% block content %}
<section class="catalog-header">
    <div class="container">
        <h1 class="catalog-title">Book Catalog</h1>
        <p class="catalog-description">Discover new books, track your reading journey, and connect with fellow readers.</p>
    </div>
</section>

<div class="container">
    <div class="filter-container">
        <div class="filter-header">
            <h3 class="filter-title">Filters</h3>
            <button class="filter-toggle">
                <span class="toggle-text">Show Filters</span>
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        
        <div class="filter-body" style="display: none;">
            <form method="get" action="{% url 'book_list' %}">
                <div class="filter-group">
                    <h4>Genres</h4>
                    <div class="genre-list">
                        {% for genre in genres %}
                            <input type="checkbox" name="genre" value="{{ genre.id }}" id="genre_{{ genre.id }}" class="genre-checkbox" {% if genre.id|stringformat:"i" in request.GET.getlist('genre') %}checked{% endif %}>
                            <label for="genre_{{ genre.id }}" class="genre-label">{{ genre.name }}</label>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="filter-group">
                    <h4>Rating</h4>
                    <div class="rating-filter">
                        <select name="rating" class="sort-select">
                            <option value="">Any Rating</option>
                            <option value="4" {% if request.GET.rating == '4' %}selected{% endif %}>4+ Stars</option>
                            <option value="3" {% if request.GET.rating == '3' %}selected{% endif %}>3+ Stars</option>
                            <option value="2" {% if request.GET.rating == '2' %}selected{% endif %}>2+ Stars</option>
                            <option value="1" {% if request.GET.rating == '1' %}selected{% endif %}>1+ Stars</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-group">
                    <h4>Publication Year</h4>
                    <div class="year-filter">
                        <label for="year_from">From</label>
                        <input type="number" name="year_from" id="year_from" placeholder="Year" min="1800" max="2025" value="{{ request.GET.year_from }}" class="sort-select">
                        
                        <label for="year_to">To</label>
                        <input type="number" name="year_to" id="year_to" placeholder="Year" min="1800" max="2025" value="{{ request.GET.year_to }}" class="sort-select">
                    </div>
                </div>
                
                <div class="filter-buttons">
                    <button type="reset" class="btn filter-reset">Reset</button>
                    <button type="submit" class="btn btn-primary">Apply Filters</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="catalog-content">
        <aside class="sidebar">
            <div class="sidebar-box">
                <h3 class="sidebar-title">Browse by Genre</h3>
                <ul class="genre-list-sidebar">
                    {% for genre in popular_genres %}
                        <li>
                            <a href="{% url 'genre_detail' genre.slug %}">
                                {{ genre.name }}
                                <span class="genre-count">{{ genre.book_count }}</span>
                            </a>
                        </li>
                    {% endfor %}
                    <li>
                        <a href="{% url 'book_list' %}?view=genres" class="view-all">
                            View all genres
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="sidebar-box">
                <h3 class="sidebar-title">Most Popular</h3>
                <div class="popular-books">
                    {% for book in popular_books %}
                        <div class="popular-book-item">
                            <a href="{{ book.get_absolute_url }}" class="popular-book-link">
                                <div class="popular-book-cover">
                                    {% if book.cover %}
                                        <img src="{{ book.cover.url }}" alt="{{ book.title }}">
                                    {% else %}
                                        <div class="no-cover">
                                            <i class="fas fa-book"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="popular-book-info">
                                    <h4 class="popular-book-title">{{ book.title }}</h4>
                                    <div class="popular-book-author">{{ book.authors.first.name }}</div>
                                    <div class="popular-book-rating">
                                        <div class="stars">
                                            {% for i in "12345" %}
                                                <i class="{% if forloop.counter <= book.get_average_rating %}fas{% else %}far{% endif %} fa-star"></i>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </aside>
        
        <div class="main-content">
            {% if request.GET %}
                <div class="active-filters">
                    {% for key, value in request.GET.items %}
                        {% if key != 'page' and key != 'sort' and value %}
                            <div class="filter-tag">
                                {% if key == 'genre' %}
                                    Genre: {{ genre_names|get_item:value }}
                                {% elif key == 'rating' %}
                                    Rating: {{ value }}+ Stars
                                {% elif key == 'year_from' %}
                                    From {{ value }}
                                {% elif key == 'year_to' %}
                                    To {{ value }}
                                {% else %}
                                    {{ key|title }}: {{ value }}
                                {% endif %}
                                <button class="remove-filter" onclick="removeFilter('{{ key }}', '{{ value }}')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        {% endif %}
                    {% endfor %}
                    
                    {% if request.GET %}
                        <a href="{% url 'book_list' %}" class="filter-tag">
                            Clear all filters
                            <i class="fas fa-times"></i>
                        </a>
                    {% endif %}
                </div>
            {% endif %}
            
            <div class="results-header">
                <div class="results-count">
                    Showing {{ books.start_index }} - {{ books.end_index }} of {{ paginator.count }} books
                </div>
                
                <div class="sort-dropdown">
                    <span class="sort-label">Sort by:</span>
                    <select name="sort" id="sort-select" class="sort-select" onchange="window.location.href = updateQueryString('sort', this.value)">
                        <option value="title" {% if request.GET.sort == 'title' %}selected{% endif %}>Title (A-Z)</option>
                        <option value="-title" {% if request.GET.sort == '-title' %}selected{% endif %}>Title (Z-A)</option>
                        <option value="-rating" {% if request.GET.sort == '-rating' or not request.GET.sort %}selected{% endif %}>Rating (High to Low)</option>
                        <option value="rating" {% if request.GET.sort == 'rating' %}selected{% endif %}>Rating (Low to High)</option>
                        <option value="-release_year" {% if request.GET.sort == '-release_year' %}selected{% endif %}>Newest First</option>
                        <option value="release_year" {% if request.GET.sort == 'release_year' %}selected{% endif %}>Oldest First</option>
                    </select>
                </div>
            </div>
            
            <div class="book-grid">
                {% for book in books %}
                    <div class="book-card">
                        <a href="{{ book.get_absolute_url }}">
                            <div class="book-cover">
                                {% if book.cover %}
                                    <img src="{{ book.cover.url }}" alt="{{ book.title }}">
                                {% else %}
                                    <div class="no-cover">
                                        <i class="fas fa-book"></i>
                                        <span>{{ book.title }}</span>
                                    </div>
                                {% endif %}
                                
                                {% if user.is_authenticated and book.id in user_reading_statuses %}
                                    <div class="book-status">
                                        {{ user_reading_statuses|get_item:book.id|get_status_display }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="book-info">
                                <h3 class="book-title">{{ book.title }}</h3>
                                <div class="book-authors">
                                    {% for author in book.authors.all %}
                                        <span>{{ author.name }}</span>{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="book-rating">
                                    <div class="stars" data-rating="{{ book.get_average_rating|floatformat:1 }}">
                                        {% for i in "12345" %}
                                            <i class="{% if forloop.counter <= book.get_average_rating %}fas{% else %}far{% endif %} fa-star"></i>
                                        {% endfor %}
                                    </div>
                                    <span class="rating-value">{{ book.get_average_rating|floatformat:1 }}</span>
                                </div>
                            </div>
                        </a>
                    </div>
                {% empty %}
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>No books found</h3>
                        <p>Try adjusting your filters or search terms</p>
                    </div>
                {% endfor %}
            </div>
            
            {% if is_paginated %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?{{ request.GET.urlencode }}&page=1"><i class="fas fa-angle-double-left"></i></a>
                        <a href="?{{ request.GET.urlencode }}&page={{ page_obj.previous_page_number }}"><i class="fas fa-angle-left"></i></a>
                    {% endif %}
                    
                    {% for i in paginator.page_range %}
                        {% if page_obj.number == i %}
                            <span class="current">{{ i }}</span>
                        {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                            <a href="?{{ request.GET.urlencode }}&page={{ i }}">{{ i }}</a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                        <a href="?{{ request.GET.urlencode }}&page={{ page_obj.next_page_number }}"><i class="fas fa-angle-right"></i></a>
                        <a href="?{{ request.GET.urlencode }}&page={{ paginator.num_pages }}"><i class="fas fa-angle-double-right"></i></a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter toggle
        const filterToggle = document.querySelector('.filter-toggle');
        const filterBody = document.querySelector('.filter-body');
        const toggleText = document.querySelector('.toggle-text');
        const toggleIcon = filterToggle.querySelector('i');
        
        if (filterToggle && filterBody) {
            filterToggle.addEventListener('click', function() {
                const isVisible = filterBody.style.display !== 'none';
                
                filterBody.style.display = isVisible ? 'none' : 'grid';
                toggleText.textContent = isVisible ? 'Show Filters' : 'Hide Filters';
                toggleIcon.className = isVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
            });
        }
        
        // Reset form
        const resetButton = document.querySelector('.filter-reset');
        if (resetButton) {
            resetButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Clear all checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Reset all selects to default
                document.querySelectorAll('select').forEach(select => {
                    select.selectedIndex = 0;
                });
                
                // Clear all inputs
                document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                    input.value = '';
                });
            });
        }
    });
    
    // Update query string helper
    function updateQueryString(key, value) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set(key, value);
        return `${window.location.pathname}?${urlParams.toString()}`;
    }
    
    // Remove filter helper
    function removeFilter(key, value) {
        const urlParams = new URLSearchParams(window.location.search);
        
        if (urlParams.getAll(key).length > 1) {
            // If there are multiple values for this key, just remove this specific one
            const values = urlParams.getAll(key).filter(v => v !== value);
            urlParams.delete(key);
            values.forEach(v => urlParams.append(key, v));
        } else {
            // Otherwise remove the key altogether
            urlParams.delete(key);
        }
        
        window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
    }
</script>
{% endblock %}